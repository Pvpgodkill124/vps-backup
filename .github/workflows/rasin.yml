name: VPS 24/7

on:
  # FIX 1: Indentation for 'schedule' and 'workflow_dispatch' 
  # must be 2 spaces under 'on:'.
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  # FIX 2: The job ID 'vps-session' is 2 spaces under 'jobs:'.
  vps-session:
    # FIX 3: All job properties (runs-on, timeout-minutes, steps) 
    # must be 4 spaces under 'vps-session:'.
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6 hours

    steps:
      # FIX 4: Each step item (- name:) must be 6 spaces under 'steps:'.
      - name: Checkout Repository
        # All step properties (uses:, with:) must be 8 spaces under the step.
        uses: actions/checkout@v4
        with:
          # Properties under 'with:' must be 10 spaces.
          token: ${{ secrets.GH_TOKEN }}

      # --- 1. SETUP VPS DIRECTORY AND PREREQUISITES ---
      - name: ‚öôÔ∏è Install Core System Prerequisites & Setup Backup Directory
        run: |
          # All lines in the 'run: |' block are typically 8 spaces.
          sudo hostnamectl set-hostname root
          sudo apt update
          # Install all necessary packages (including 'zip' which is needed later)
          sudo apt install -y tmate curl unzip sudo net-tools neofetch git mariadb-server zip

          # Define the dedicated backup staging directory
          BACKUP_DIR="/opt/VpsBackUp" 
          # Create the directory structure with appropriate permissions
          sudo mkdir -p "${BACKUP_DIR}/data"
          sudo chown $USER:$USER "${BACKUP_DIR}" "${BACKUP_DIR}/data"
          
      - name: üì¶ Retrieve Previous Backup from 'backup' Branch
        run: |
          echo "::group::Retrieving backup from Git branch"
          BACKUP_REPO_DIR=./backup/repo
          # Clone the backup branch
          git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}
          
          # Check if the backup was successful and extract files
          if [ -d "${BACKUP_REPO_DIR}" ]; then
            echo "Backup repo cloned successfully. Extracting files..."
            # Copy contents of the data folder only, preserving all files and folders
            cp -r ${BACKUP_REPO_DIR}/data/* ${BACKUP_DIR}/data/ || true 
            echo "Files copied to staging directory."
          else
            echo "Warning: Backup branch clone failed. Starting from a fresh environment."
          fi
          # Clean up the temporary repo folder
          rm -rf ${BACKUP_REPO_DIR}
          echo "::endgroup::"
          
      # --- 2. RUN VPS SESSION AND CREATE NEW BACKUP DATA (Placeholder for your main logic) ---
      - name: ‚ú® Run VPS Session and Create New Backup Data
        run: |
          echo "NOTE: Insert your tmate, server, or VPS-related run commands here."
          # This is the step where your environment will be active 
          # and generate the new files that you want to back up.
          # Example: Your tmate script, or a script to dump a new DB backup.
          # Ensure any new files are saved inside /opt/VpsBackUp/data/
          
      # --- 2.5. Archive the Backup for Commit ---
      - name: üíæ Create final ZIP archive of the new backup
        run: |
          # Navigate to a safe location (e.g., repository root)
          cd ${{ github.workspace }}
          # Create the final zip archive, starting from the new backup folder
          # The zip file will contain a top-level folder named 'VpsBackUp'
          zip -r backup.zip /opt/VpsBackUp
          # The file 'backup.zip' is now ready to be committed.


      # --- 3. Commit and Merge the Backup ---
      # This entire section commits the 'backup.zip' file to the 'backup' branch
      - name: üîÑ Create Pull Request with Backup (Auto-Merge Start)
        id: cpr
        uses: peter-evans/create-pull-request@v6
        if: always()
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'ü§ñ Automated Backup: Workflow ${{ github.run_id }}'
          title: 'Auto-Merge Backup: Workflow ${{ github.run_id }}'
          # A temporary branch name to create the PR from
          branch: backup-auto-merge-${{ github.run_id }} 
          # The target branch for the PR
          base: backup 
          body: |
            Automated workflow run created a new backup.
            This Pull Request will be merged automatically.
          # The file to be committed
          add-paths: backup.zip

      - name: ‚úÖ Auto-Merge the Pull Request (Human-Free Backup)
        # Only run if a PR was successfully created
        if: steps.cpr.outputs.pull-request-number != ''
        run: |
          PR_NUMBER=${{ steps.cpr.outputs.pull-request-number }}
          echo "Merging PR #$PR_NUMBER..."
          curl -L \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge
          echo "PR #$PR_NUMBER merged."
