name: VPS 24/7
on:schedule:
- cron: '0 */6 * * *'
workflow_dispatch:
jobs:
vps-session:
runs-on: ubuntu-latest
timeout-minutes: 350  # Just under 6 hourssteps:


  - name: Checkout Repository
    uses: actions/checkout@v4
    with:
      # Line 15 is here. Ensure this 'token' line is indented exactly two spaces from 'with:'.
      token: ${{ secrets.GH_TOKEN }}

  # --- 1. SETUP VPS DIRECTORY AND PREREQUISITES ---
  - name: âš™ï¸ Install Core System Prerequisites & Setup Backup Directory
    run: |
      sudo hostnamectl set-hostname root
      sudo apt update
      # Install all necessary packages (including 'zip' which is needed later)
      sudo apt install -y tmate curl unzip sudo net-tools neofetch git mariadb-server zip

      # Define the dedicated backup staging directory
      BACKUP_DIR="/opt/VpsBackUp" 
      # Create the directory structure with appropriate permissions
      sudo mkdir -p "${BACKUP_DIR}/data"
      sudo chown $USER:$USER "${BACKUP_DIR}" "${BACKUP_DIR}/data"
      
  - name: ðŸ“¦ Retrieve Previous Backup from 'backup' Branch
    run: |
      echo "::group::Retrieving backup from Git branch"
      BACKUP_REPO_DIR=./backup/repo
      # Clone the backup branch
      git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
      git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}

      if [ -f ${BACKUP_REPO_DIR}/backup.zip ];
      then
        mkdir -p ./backup
        mv ${BACKUP_REPO_DIR}/backup.zip ./backup/backup.zip
        echo "Found previous backup. Unzipping..."
        # Unzip the contents back to the root directory
        sudo unzip -o ./backup/backup.zip -d /
        echo "Restore complete."
        
        # Since /root was backed up as /opt/VpsBackUp/data/root_home, we restore it here.
        # Move contents of the temporary root_home staging area back to /root/
        sudo cp -a /opt/VpsBackUp/data/root_home/. /root/ 
        echo "/root/ files restored."
        
      else
        echo "No previous backup found. Starting fresh."
      fi
      echo "::endgroup::"
  
  # [Your main runtime tasks like tmate/tailscale execution would run here]

  # --- 2. CREATE NEW BACKUP ---
  - name: ðŸ’¾ Create New Backup and Zip Files
    run: |
      BACKUP_DIR="/opt/VpsBackUp" 
      BACKUP_DATA_DIR="${BACKUP_DIR}/data"
      
      # Clean up previous temporary files that might have been restored
      sudo rm -rf ${BACKUP_DATA_DIR}/root_home/
      
      # 2.1. Copy the contents of /root/ (the home directory of the root user)
      # The new location will be /opt/VpsBackUp/data/root_home
      sudo mkdir -p "${BACKUP_DATA_DIR}/root_home"
      echo "Copying /root/ contents to backup staging..."
      # The -a flag preserves permissions and copies hidden files
      sudo cp -a /root/. ${BACKUP_DATA_DIR}/root_home/
      # Remove the temporary current directory reference that cp might create
      sudo rm -f ${BACKUP_DATA_DIR}/root_home/.

      # 2.2. Copy Tailscale state (optional, only if using Tailscale)
      echo "Copying Tailscale state..."
      sudo cp /var/lib/tailscale/tailscaled.state ${BACKUP_DATA_DIR}/

      # 2.3. Clean up before zipping (removes large/unnecessary files)
      echo "Cleaning up temporary files..."
      sudo rm -rf ${BACKUP_DATA_DIR}/root_home/.cache
      sudo rm -f ${BACKUP_DATA_DIR}/root_home/.tmate.sock ${BACKUP_DATA_DIR}/root_home/.bash_history

      # 2.4. Change ownership for the runner to zip the file without sudo
      sudo chown -R $USER:$USER ${BACKUP_DIR}

      # 2.5. Create the final zip archive, starting from the new backup folder
      zip -r backup.zip ${BACKUP_DIR}

  # 3. Commit and Merge the Backup

  # 3.1. Create a Pull Request with the new backup file
  - name: ðŸ”„ Create Pull Request with Backup (Auto-Merge Start)
    id: cpr
    uses: peter-evans/create-pull-request@v6
    if: always()
    with:
      token: ${{ secrets.GH_TOKEN }}
      commit-message: 'ðŸ¤– Automated Backup: Workflow ${{ github.run_id }}'
      title: 'Auto-Merge Backup: Workflow ${{ github.run_id }}'
      branch: backup-auto-merge-${{ github.run_id }}
      base: backup
      body: |
        Automated workflow run created a new backup.
        This Pull Request will be merged automatically.
      add-paths: backup.zip

  # 3.2. Immediately Merge the Pull Request
  - name: âœ… Auto-Merge the Pull Request (Human-Free Backup)
    if: steps.cpr.outputs.pull-request-number != ''
    run: |
      PR_NUMBER=${{ steps.cpr.outputs.pull-request-number }}
      echo "Merging PR #$PR_NUMBER..."
      curl -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
        -d '{"commit_title":"MERGED: Auto Backup Commit","commit_message":"This PR was auto-merged after a successful backup run."}'
      echo "Merge command executed."
