name: VPS 24/7 (Debian 11 Container)

on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    # Explicitly use the minimal Debian 11 container
    runs-on: ubuntu-latest
    timeout-minutes: 350

    container: debian:bullseye-slim

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: âš™ï¸ Install Core System Prerequisites & Applications
        run: |
          # Define staging directory variables
          BACKUP_DIR="/opt/vps-backup"
          BACKUP_DATA_DIR="${BACKUP_DIR}/data"
          
          # Install core packages, including openssh-server (for sshd_config) and bash (for disown)
          apt update -y
          apt install -y tmate curl unzip net-tools neofetch git mariadb-server zip sudo rsync nginx openssh-server lsb-release ca-certificates gnupg software-properties-common bash
          
          # Install Pterodactyl dependencies 
          apt install -y php-cli php-fpm php-mysql php-pdo php-mbstring php-tokenizer php-bcmath php-xml php-zip
          
          hostnamectl set-hostname root || true
          
          # Create the primary backup staging directory
          mkdir -p "${BACKUP_DATA_DIR}"
          
          # Ensure runner user owns the backup directory
          chown -R $(whoami):$(whoami) ${BACKUP_DIR} || true
 
      - name: ðŸ“¦ Retrieve Previous Backup from 'backup' Branch
        run: |
          echo "::group::Retrieving backup from Git branch"
          BACKUP_REPO_DIR=./backup/repo
          
          git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
          git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}
          
          if [ -f ${BACKUP_REPO_DIR}/backup.zip ];
          then
            mkdir -p ./backup
            mv ${BACKUP_REPO_DIR}/backup.zip ./backup/backup.zip
            echo "Backup file retrieved successfully."
          else
            echo "No backup file found on 'backup' branch."
          fi
          
          rm -rf ${BACKUP_REPO_DIR}
          echo "::endgroup::"
          
      - name: ðŸ”„ Restore Files and Tailscale State
        run: |
          echo "Restoring previous session files..."
          BACKUP_DATA_DIR="/opt/vps-backup/data"
          
          if [ -f ./backup/backup.zip ];
          then
            # Unzip all contents to the root directory for restoration
            unzip -o ./backup/backup.zip -d /
            echo "Session files restored to /opt/vps-backup/."
            
            # --- START RESTORATION OF PERSISTENT FOLDERS ---
            
            # ðŸ”‘ /root/ contents (Uses rsync for robust dotfile persistence)
            if [ -d ${BACKUP_DATA_DIR}/root_home ];
            then
                echo "Restoring /root contents using rsync..."
                rsync -a ${BACKUP_DATA_DIR}/root_home/. /root/ || true
                chown -R root:root /root || true
            fi
            
            # /incase folder
            if [ -d ${BACKUP_DATA_DIR}/incase ];
            then
                echo "Restoring /incase contents using rsync..."
                mkdir -p /incase
                rsync -a ${BACKUP_DATA_DIR}/incase/. /incase/ || true
            fi
            
            # Pterodactyl Panel files
            if [ -d ${BACKUP_DATA_DIR}/pterodactyl_panel ]; then
                echo "Restoring Pterodactyl Panel files..."
                mkdir -p /var/www/pterodactyl
                rsync -a ${BACKUP_DATA_DIR}/pterodactyl_panel/. /var/www/pterodactyl/ || true
            fi
            
            # Pterodactyl Wings data
            if [ -d ${BACKUP_DATA_DIR}/pterodactyl_wings ]; then
                echo "Restoring Pterodactyl Wings data..."
                mkdir -p /var/lib/pterodactyl
                rsync -a ${BACKUP_DATA_DIR}/pterodactyl_wings/. /var/lib/pterodactyl/ || true
            fi
            
            # Nginx Configuration
            if [ -d ${BACKUP_DATA_DIR}/etc_nginx ]; then
                echo "Restoring Nginx configuration..."
                sudo rsync -a ${BACKUP_DATA_DIR}/etc_nginx/. /etc/nginx/ || true
            fi
            
            # --- END RESTORATION OF PERSISTENT FOLDERS ---

          else
            echo "No backup found, starting fresh."
          fi
          
          # Restore Tailscale state
          if [ -f ${BACKUP_DATA_DIR}/tailscaled.state ];
          then
            mkdir -p /var/lib/tailscale
            cp ${BACKUP_DATA_DIR}/tailscaled.state /var/lib/tailscale/tailscaled.state
            chmod 600 /var/lib/tailscale/tailscaled.state
            echo "Tailscale state restored."
          fi
 
      - name: ðŸŒ Install Networking Tools (Tailscale, Cloudflared, Playit)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Install Cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          install cloudflared /usr/local/bin/cloudflared
          
          # Install Playit.gg Agent
          echo "Setting up Playit.gg PPA..."
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | tee /etc/apt/sources.list.d/playit-cloud.list
          apt update -y
          apt install -y playit
          
      - name: ðŸ”‘ Configure Root User and SSH Access (Non-Systemd Fix)
        run: |
          # Use the script to set up SSH keys and environment
          sh -c "$(curl -s https://raw.githubusercontent.com/JishnuTheGamer/Vps/refs/heads/main/cd/root)"
          
          echo "root:root" | chpasswd
          echo "root ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/root
          
          # Configure SSH to permit root login
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          
          # CRITICAL FIX: Manually start the SSH daemon (sshd) directly
          echo "Starting SSH Daemon directly..."
          /usr/sbin/sshd || echo "Direct SSH start failed, continuing."

      - name: ðŸš€ Start Networking Services & Database (Crash-Proof Daemon Fixes)
        # Use bash for robust backgrounding with 'disown'
        shell: /bin/bash {0} 
        run: |
          # --- CRITICAL FIX: Ensure MySQL/MariaDB socket directory exists and has permissions ---
          MYSQL_SOCK_DIR="/var/run/mysqld"
          MYSQL_SOCK_FILE="${MYSQL_SOCK_DIR}/mysqld.sock"
          echo "Creating MySQL socket directory: ${MYSQL_SOCK_DIR}"
          mkdir -p ${MYSQL_SOCK_DIR}
          chown -R mysql:mysql ${MYSQL_SOCK_DIR}
          chmod 777 ${MYSQL_SOCK_DIR} # Loosening permissions for container environment
          
          # --- FIX: Start MariaDB/MySQL Daemon directly (no systemctl) ---
          echo "Starting MariaDB daemon directly..."
          # Start mariadbd, explicitly setting the socket path to the one we created
          # Use nohup/disown to robustly detach the process
          nohup /usr/sbin/mariadbd --user=mysql --basedir=/usr --datadir=/var/lib/mysql --pid-file=/var/run/mysqld/mysqld.pid --socket=${MYSQL_SOCK_FILE} --port=3306 > /dev/null 2>&1 & disown
          
          # Wait 10 seconds for the DB to initialize the socket
          echo "Waiting 10 seconds for MariaDB to start..."
          sleep 10
          
          # Restore Pterodactyl Database
          if [ -f /opt/vps-backup/data/pterodactyl_db.sql ];
          then
              echo "Re-importing Pterodactyl database..."
              # Use the mysql client, explicitly passing the correct socket path
              mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} --socket=${MYSQL_SOCK_FILE} panel < /opt/vps-backup/data/pterodactyl_db.sql || echo "Database restore failed. Check DB password secret."
          fi
          
          # --- FIX: Run tailscaled directly with nohup/disown ---
          TS_SOCK="/var/run/tailscale/tailscaled.sock"
          TS_STATE_DIR="/var/lib/tailscale"
          echo "Starting Tailscale daemon directly in background..."
          nohup tailscaled --state=${TS_STATE_DIR}/tailscaled.state > /dev/null 2>&1 & disown

          # Wait loop for the daemon socket to appear
          echo "Waiting for Tailscale daemon socket to appear at $TS_SOCK..."
          for i in $(seq 1 45); do 
              if [ -S "$TS_SOCK" ]; then
                  echo "Tailscale daemon is running. Proceeding."
                  break
              fi
              echo "Attempt $i/45: Socket not found. Sleeping 1 second..."
              sleep 1
              if [ "$i" -eq 45 ]; then
                  echo "FATAL: Tailscale daemon failed to start within 45 seconds."
                  echo "WARNING: Tailscale services may not be available."
                  break
              fi
          done
          
          # Bring the Tailscale interface up (only if the daemon started)
          if [ -S "$TS_SOCK" ]; then
            tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root --reset || echo "Tailscale UP failed, continuing."
          else
            echo "Tailscale daemon socket not found. Skipping 'tailscale up'."
          fi

          # Start Cloudflare Tunnel
          CLEAN_TOKEN=$(echo "${{ secrets.CF_TUNNEL_TOKEN }}" | tr -cd '[:print:]')
          /usr/local/bin/cloudflared tunnel run --token "$CLEAN_TOKEN" & disown
          
          # Start Playit.gg
          playit --secret ${{ secrets.PLAYIT_SECRET_KEY }} & disown
          
          # CRITICAL FIX: Tailscale Funnel command syntax
          echo "Starting Tailscale Funnel on port 8080..."
          tailscale serve 8080 http://localhost:8080 & disown

          sleep 5

      - name: Start Tmate Server (Non-Blocking)
        run: tmate -S /tmp/tmate.sock new-session -d
 
      - name: ðŸ“£ VPS Connection Details (Ultimate Access)
        run: |
          echo "=========================================="
          echo "â­ Access Details"
          echo "------------------------------------------"
          echo "ðŸ“ Tailscale MagicDNS Name: root"
          echo "ðŸ’» Tailscale IP (Internal VPN):"
          # Get IP only if the daemon socket exists
          TS_SOCK="/var/run/tailscale/tailscaled.sock"
          if [ -S "$TS_SOCK" ]; then
             tailscale ip -4 || echo "Tailscale IP not found (Post-Startup Failure)"
          else
             echo "Tailscale daemon socket not available. IP unknown."
          fi
          echo "=========================================="
 
      - name: Sleep to Keep VPS Alive (6 Hours)
        run: sleep 21600
 
      # --- CANCELLATION-SAFE BACKUP STEPS ---
      - name: ðŸ’¾ Create Backup Archive (CRASH-PROOF & PERSISTENT)
        if: always()
        run: |
          BACKUP_DIR="/opt/vps-backup"
          BACKUP_DATA_DIR="${BACKUP_DIR}/data"
          
          # --- DUMP DATABASE ---
          # Define the correct socket path again for the backup step
          MYSQL_SOCK_FILE="/var/run/mysqld/mysqld.sock"
          
          echo "Attempting to dump Pterodactyl database..."
          # Pass the socket path explicitly to mysqldump
          mysqldump -u root -p${{ secrets.DB_ROOT_PASSWORD }} --socket=${MYSQL_SOCK_FILE} panel > ${BACKUP_DATA_DIR}/pterodactyl_db.sql 2>/dev/null || echo "DB DUMP FAILED. Continuing."
          
          # --- START COPYING LIVE DATA INTO STAGING ---
          
          # 1. /root/ contents (Using rsync for comprehensive backup)
          echo "Copying /root directory contents using rsync..."
          mkdir -p ${BACKUP_DATA_DIR}/root_home
          rsync -a /root/. ${BACKUP_DATA_DIR}/root_home/

          # 2. /incase/ folder (Using rsync for comprehensive backup)
          echo "Copying /incase directory contents using rsync..."
          mkdir -p ${BACKUP_DATA_DIR}/incase
          if [ -d /incase ];
          then
            rsync -a /incase/. ${BACKUP_DATA_DIR}/incase/
          else
            echo "/incase directory does not exist yet. Skipping."
          fi
          
          # 3. Pterodactyl Panel files
          echo "Copying Pterodactyl Panel files (if present)..."
          mkdir -p ${BACKUP_DATA_DIR}/pterodactyl_panel
          if [ -d /var/www/pterodactyl ]; then
            rsync -a /var/www/pterodactyl/. /${BACKUP_DATA_DIR}/pterodactyl_panel/ || true
          fi
          
          # 4. Pterodactyl Wings/Server data
          echo "Copying Pterodactyl Wings/Server data (if present)..."
          mkdir -p ${BACKUP_DATA_DIR}/pterodactyl_wings
          if [ -d /var/lib/pterodactyl ]; then
            rsync -a /var/lib/pterodactyl/. ${BACKUP_DATA_DIR}/pterodactyl_wings/ || true
          fi
          
          # 5. Tailscale state (Crash-proof copy)
          echo "Copying Tailscale state (allowing failure if service is down)..."
          cp /var/lib/tailscale/tailscaled.state ${BACKUP_DATA_DIR}/ || true 

          # 6. Nginx/Systemd configs
          sudo mkdir -p ${BACKUP_DATA_DIR}/etc_nginx ${BACKUP_DATA_DIR}/etc_systemd
          if [ -d /etc/nginx ]; then sudo rsync -a /etc/nginx/. ${BACKUP_DATA_DIR}/etc_nginx/; fi
          
          # --- ZIP THE STAGING AREA ---
          
          # Cleanup cache/temporary files before zipping
          rm -rf ${BACKUP_DATA_DIR}/root_home/.cache ${BACKUP_DATA_DIR}/root_home/.tmate.sock ${BACKUP_DATA_DIR}/root_home/.bash_history
          
          # Set ownership for the host to handle the file
          chown -R $(whoami):$(whoami) ${BACKUP_DIR}
          
          # Zip the file directly in the workspace root
          zip -r backup.zip ${BACKUP_DIR}
 
      - name: âœ… Atomic Force-Push New Backup to 'backup' Branch (SHELL-NATIVE FIX)
        if: always()
        run: |
          cd $GITHUB_WORKSPACE
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add backup.zip
          
          # Check if there are any changes to commit
          if git status --porcelain | grep -q .; then
            git commit -m 'ðŸ¤– Automated Backup: Workflow ${{ github.run_id }}'
            # Force push the new backup, creating the branch if necessary
            git push --force origin backup || git push --force --set-upstream origin backup
          else
            echo "No changes in backup.zip, skipping commit."
          fi
