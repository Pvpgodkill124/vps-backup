name: VPS 24/7 (Debian 11 Container)

on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    container: debian:bullseye-slim

    steps:
      # NOTE: This runs on the host (ubuntu-latest) and sets up the git workspace
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      # üîë FIX 1: Install 'sudo' package inside the minimal container
      - name: ‚öôÔ∏è Install Core System Prerequisites & Setup Backup Directory (Inside Debian 11)
        run: |
          # Install 'sudo' here to resolve "sudo: not found" error when accessing host-level resources
          apt update -y
          apt install -y tmate curl unzip net-tools neofetch git mariadb-server zip sudo

          # Configure hostname
          hostnamectl set-hostname root || true
          
          # Define standard staging directory
          BACKUP_DIR="/opt/vps-backup"
          BACKUP_DATA_DIR="${BACKUP_DIR}/data"
          
          # Create the primary staging directory (no sudo needed as root)
          mkdir -p "${BACKUP_DATA_DIR}"
 
      - name: üì¶ Retrieve Previous Backup from 'backup' Branch
        # Use a separate job step to explicitly fetch the backup branch files
        run: |
          echo "::group::Retrieving backup from Git branch"
          BACKUP_REPO_DIR=./backup/repo
          
          # Clone backup branch
          git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
          git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}
          if [ -f ${BACKUP_REPO_DIR}/backup.zip ];
          then
            mkdir -p ./backup
            mv ${BACKUP_REPO_DIR}/backup.zip ./backup/backup.zip
            echo "Backup file retrieved successfully."
          else
            echo "No backup file found on 'backup' branch."
          fi
          
          rm -rf ${BACKUP_REPO_DIR}
          echo "::endgroup::"
          
      - name: üîÑ Restore Files and Tailscale State (FULL PERSISTENCE)
        run: |
          echo "Restoring previous session files..."
          BACKUP_DATA_DIR="/opt/vps-backup/data"
          
          if [ -f ./backup/backup.zip ];
          then
            # Unzip restores files to the directory structure they were zipped from
            unzip -o ./backup/backup.zip -d /
            echo "Session files restored to /opt/vps-backup/."
            
            # --- START RESTORATION OF PERSISTENT FOLDERS ---
            
            # Restore /root home (no sudo needed)
            if [ -d ${BACKUP_DATA_DIR}/root_home ];
            then
                echo "Restoring /root contents..."
                cp -a ${BACKUP_DATA_DIR}/root_home/. /root/
            fi
            
            # Restore /incase folder
            if [ -d ${BACKUP_DATA_DIR}/incase ];
            then
                echo "Restoring /incase contents..."
                mkdir -p /incase
                cp -a ${BACKUP_DATA_DIR}/incase/. /incase/
            fi
            
            # Restore Pterodactyl Panel files (/var/www/pterodactyl)
            if [ -d ${BACKUP_DATA_DIR}/pterodactyl_panel ]; then
                mkdir -p /var/www/pterodactyl
                cp -a ${BACKUP_DATA_DIR}/pterodactyl_panel/. /var/www/pterodactyl/
            fi
            
            # Restore Pterodactyl Wings data (/var/lib/pterodactyl)
            if [ -d ${BACKUP_DATA_DIR}/pterodactyl_wings ]; then
                mkdir -p /var/lib/pterodactyl
                cp -a ${BACKUP_DATA_DIR}/pterodactyl_wings/. /var/lib/pterodactyl/
            fi
            
            # Restore Nginx Configuration - requires 'sudo' to interact with the runner's system files
            if [ -d ${BACKUP_DATA_DIR}/etc_nginx ]; then
                echo "Restoring Nginx configuration..."
                sudo cp -a ${BACKUP_DATA_DIR}/etc_nginx/. /etc/nginx/
            fi
            
            # Restore Custom Systemd Service Files - requires 'sudo' to interact with the runner's system files
            if [ -d ${BACKUP_DATA_DIR}/etc_systemd ]; then
                echo "Restoring systemd service files..."
                sudo cp -a ${BACKUP_DATA_DIR}/etc_systemd/. /etc/systemd/system/
                sudo systemctl daemon-reload
            fi
            
            # --- END RESTORATION OF PERSISTENT FOLDERS ---

          else
            echo "No backup found, starting fresh."
          fi
          
          # Restore Tailscale state (separate due to /var/lib requirements)
          if [ -f ${BACKUP_DATA_DIR}/tailscaled.state ];
          then
            mkdir -p /var/lib/tailscale
            cp ${BACKUP_DATA_DIR}/tailscaled.state /var/lib/tailscale/tailscaled.state
            chmod 600 /var/lib/tailscale/tailscaled.state
            echo "Tailscale state restored."
          fi
 
      # --- Networking and Service Installation Steps ---
      
      - name: üåê Install Networking Tools (Tailscale, Cloudflared, Playit)
        run: |
          # Note: Tailscale install script handles Debian correctly
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Install Cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          install cloudflared /usr/local/bin/cloudflared
        
          
      - name: üîë Configure Root User and SSH Access
        run: |
          # Use 'sh' to ensure compatibility across Debian/Ubuntu runtimes
          sh -c "$(curl -s https://raw.githubusercontent.com/JishnuTheGamer/Vps/refs/heads/main/cd/root)"
          
          echo "root:root" | chpasswd
          echo "root ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/root
          
          # Need sudo for runner's system files outside the container's virtual root
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh || echo "SSH restart failed, continuing."

      - name: üöÄ Start Networking Services & Database
        run: |
          # Start Database (Use sudo as systemctl is a host-level service)
          sudo systemctl start mariadb || sudo systemctl start mysql || echo "Database service start failed."
          
          # Restore Pterodactyl Database (runs inside container)
          if [ -f /opt/vps-backup/data/pterodactyl_db.sql ];
          then
              echo "Re-importing Pterodactyl database..."
              mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} panel < /opt/vps-backup/data/pterodactyl_db.sql || echo "Database restore failed. Check DB password secret."
          fi
          
          # Start Tailscale
          tailscaled &
          sleep 8
          tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root --reset || echo "Tailscale already up/error"
          
          # Start Cloudflare Tunnel
          CLEAN_TOKEN=$(echo "${{ secrets.CF_TUNNEL_TOKEN }}" | tr -cd '[:print:]')
          /usr/local/bin/cloudflared tunnel run --token "$CLEAN_TOKEN" &
           
          
          # Start Tailscale Funnel
          echo "Starting Tailscale Funnel on port 80..."
          tailscale funnel 8080 on &

          sleep 5

      - name: Start Tmate Server (Non-Blocking)
        run: tmate -S /tmp/tmate.sock new-session -d
 
      - name: üì£ VPS Connection Details (Ultimate Access)
        run: |
          echo "=========================================="
          echo "‚≠ê Access Details"
          echo "------------------------------------------"
          echo "üìç Tailscale MagicDNS Name: root"
          echo "üíª Tailscale IP (Internal VPN):"
          tailscale ip -4 || echo "Tailscale IP not found"
          echo "=========================================="
 
      - name: Sleep to Keep VPS Alive (6 Hours)
        run: sleep 21600
 
      # --- CANCELLATION-SAFE BACKUP STEPS ---
      - name: üíæ Create Backup Archive (FULL CONFIGURATION PERSISTENCE)
        if: always()
        run: |
          BACKUP_DIR="/opt/vps-backup"
          BACKUP_DATA_DIR="${BACKUP_DIR}/data"
          
          # --- DUMP DATABASE ---
          echo "Attempting to dump Pterodactyl database..."
          # No change here, systemctl still needs sudo/host context
          sudo systemctl start mariadb 2>/dev/null || true
          mysqldump -u root -p${{ secrets.DB_ROOT_PASSWORD }} panel > ${BACKUP_DATA_DIR}/pterodactyl_db.sql 2>/dev/null || echo "DB DUMP FAILED. Continuing."
          
          # --- START COPYING AND BACKUP UP ---
          # All 'cp' commands no longer need 'sudo' as we are root inside the container,
          # but the host-level copies need it (Nginx/Systemd)

          # 1. /root/ contents
          echo "Copying /root directory contents..."
          mkdir -p ${BACKUP_DATA_DIR}/root_home
          cp -a /root/. ${BACKUP_DATA_DIR}/root_home/

          # 2. /incase/ folder 
          echo "Copying /incase directory contents..."
          mkdir -p ${BACKUP_DATA_DIR}/incase
          if [ -d /incase ];
          then
            cp -a /incase/. ${BACKUP_DATA_DIR}/incase/
          else
            echo "/incase directory does not exist yet. Skipping."
          fi
          
          # 3. Pterodactyl Panel files
          echo "Copying Pterodactyl Panel files (if present)..."
          mkdir -p ${BACKUP_DATA_DIR}/pterodactyl_panel
          if [ -d /var/www/pterodactyl ]; then
            cp -a /var/www/pterodactyl/. ${BACKUP_DATA_DIR}/pterodactyl_panel/
          fi
          
          # 4. Pterodactyl Wings/Server data
          echo "Copying Pterodactyl Wings/Server data (if present)..."
          mkdir -p ${BACKUP_DATA_DIR}/pterodactyl_wings
          if [ -d /var/lib/pterodactyl ]; then
            cp -a /var/lib/pterodactyl/. ${BACKUP_DATA_DIR}/pterodactyl_wings/
          fi
          
          # 5. Tailscale state
          echo "Copying Tailscale state..."
          cp /var/lib/tailscale/tailscaled.state ${BACKUP_DATA_DIR}/

          # 6. Nginx/Systemd configs (Requires sudo to copy from runner's system paths)
          # These paths are on the host OS, so 'sudo' is required.
          sudo mkdir -p ${BACKUP_DATA_DIR}/etc_nginx ${BACKUP_DATA_DIR}/etc_systemd
          if [ -d /etc/nginx ]; then sudo cp -a /etc/nginx/. ${BACKUP_DATA_DIR}/etc_nginx/; fi
          if [ -d /etc/systemd/system ]; then sudo cp -a /etc/systemd/system/. ${BACKUP_DATA_DIR}/etc_systemd/; fi

          # --- CLEANUP AND ZIP ---
          
          # Cleanup cache/temporary files before zipping (no sudo needed)
          rm -rf ${BACKUP_DATA_DIR}/root_home/.cache ${BACKUP_DATA_DIR}/root_home/.tmate.sock ${BACKUP_DATA_DIR}/root_home/.bash_history
          
          # Set ownership back to runner user for the host to handle the file (no sudo needed, as we are root)
          chown -R $USER:$USER ${BACKUP_DIR}
          
          # üîë FIX 2: Create the final zip archive *directly in the $GITHUB_WORKSPACE* # which is the current working directory, for the push action to find it.
          # We use `mv` to move the zip out of the container's staging path into the Git workspace.
          zip -r /home/runner/work/${{ github.repository }}/${{ github.repository }}/backup.zip ${BACKUP_DIR}
 
      # üîë FIX 2: Removed 'files' input as it is not supported by this action.
      - name: ‚úÖ Atomic Force-Push New Backup to 'backup' Branch
        if: always()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          branch: backup
          force: true
          # The action will commit and push any changes in the workspace,
          # including the new backup.zip file now located at the workspace root.
