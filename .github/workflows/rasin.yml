name: VPS 24/7
 
on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:
 
jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6 hours

steps:
- name: Checkout Repository
    uses: actions/checkout@v4
    with:
      token: ${{ secrets.GH_TOKEN }}

  # --- 1. SETUP VPS DIRECTORY ---
  - name: âš™ï¸ Install Core System Prerequisites & Setup Backup Directory
    run: |
      sudo hostnamectl set-hostname root
      sudo apt update
      sudo apt install -y tmate curl unzip sudo net-tools neofetch git mariadb-server zip

      # Define the dedicated backup staging directory
      BACKUP_DIR="/opt/VpsBackUp" 
      sudo mkdir -p "${BACKUP_DIR}/data"
      sudo chown $USER:$USER "${BACKUP_DIR}" "${BACKUP_DIR}/data"
      
  - name: ðŸ“¦ Retrieve Previous Backup from 'backup' Branch
    run: |
      echo "::group::Retrieving backup from Git branch"
      BACKUP_REPO_DIR=./backup/repo
      # Clones backup branch using two methods for robustness
      git clone --single-branch --branch backup https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR} 2>/dev/null || \
      git clone https://oauth2:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${BACKUP_REPO_DIR}

      if [ -f ${BACKUP_REPO_DIR}/backup.zip ];
      then
        mkdir -p ./backup
        mv ${BACKUP_REPO_DIR}/backup.zip ./backup/backup.zip
        echo "Found previous backup. Unzipping..."
        unzip -o ./backup/backup.zip -d /
        echo "Restore complete."
      else
        echo "No previous backup found. Starting fresh."
      fi
      echo "::endgroup::"
  
  # [Intermediate steps for running the VPS session, e.g., OpenVPN, etc., go here]
  # Assuming your current tmate/tailscale setup runs here and generates files.

  # --- 2. CREATE NEW BACKUP ---
  - name: ðŸ’¾ Create New Backup and Zip Files
    run: |
      BACKUP_DIR="/opt/VpsBackUp" 
      BACKUP_DATA_DIR="${BACKUP_DIR}/data"

      # 2.1. Copy the contents of /root/ (the home directory of the root user)
      # We use a temporary staging area for the root home to avoid permission issues
      sudo mkdir -p "${BACKUP_DATA_DIR}/root_home"
      echo "Copying /root/ contents to backup staging..."
      # The -a flag preserves permissions, timestamps, etc.
      # The .* includes hidden files, the * includes non-hidden files.
      sudo cp -a /root/. ${BACKUP_DATA_DIR}/root_home/
      # Remove the temporary current directory reference that cp might create
      sudo rm -f ${BACKUP_DATA_DIR}/root_home/.

      # 2.2. Copy Tailscale state (if you are using Tailscale for the VPN)
      echo "Copying Tailscale state..."
      sudo cp /var/lib/tailscale/tailscaled.state ${BACKUP_DATA_DIR}/

      # 2.3. Clean up before zipping (removes large/unnecessary files)
      echo "Cleaning up temporary files..."
      sudo rm -rf ${BACKUP_DATA_DIR}/root_home/.cache
      sudo rm -f ${BACKUP_DATA_DIR}/root_home/.tmate.sock ${BACKUP_DATA_DIR}/root_home/.bash_history

      # 2.4. Change ownership for the runner to zip the file without sudo
      sudo chown -R $USER:$USER ${BACKUP_DIR}

      # 2.5. Create the final zip archive, starting from the root directory (/)
      # We zip the contents of /opt/VpsBackUp
      zip -r backup.zip ${BACKUP_DIR}

  # 1. Create a Pull Request with the new backup file
  - name: ðŸ”„ Create Pull Request with Backup (Auto-Merge Start)
    id: cpr
    uses: peter-evans/create-pull-request@v6
    if: always()
    with:
      token: ${{ secrets.GH_TOKEN }}
      commit-message: 'ðŸ¤– Automated Backup: Workflow ${{ github.run_id }}'
      title: 'Auto-Merge Backup: Workflow ${{ github.run_id }}'
      branch: backup-auto-merge-${{ github.run_id }}
      base: backup
      body: |
        Automated workflow run created a new backup.
        This Pull Request will be merged automatically.
      add-paths: backup.zip

  # 2. Immediately Merge the Pull Request
  - name: âœ… Auto-Merge the Pull Request (Human-Free Backup)
    if: steps.cpr.outputs.pull-request-number != ''
    run: |
      PR_NUMBER=${{ steps.cpr.outputs.pull-request-number }}
      echo "Merging PR #$PR_NUMBER..."
      curl -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
        -d '{"commit_title":"MERGED: Auto Backup Commit","commit_message":"This PR was auto-merged after a successful backup run."}'
      echo "Merge command executed."
